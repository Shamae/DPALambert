<!DOCTYPE html>
<html>

<head>
  <title>Degenesis Worldmap</title>
  <link rel="icon" href="img/favicon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

  <link rel="stylesheet" href="css/SMV.css" />
  <link rel="stylesheet" href="css/DPALambert.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.pm@0.17.3/dist/leaflet.pm.css" />
  <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.css" />



  <script src="src/SMVlib.js"></script>
  <script src="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.pm@0.17.3/dist/leaflet.pm.min.js"></script>

  <link rel="stylesheet" href="plugins/Leaflet.StyledLayerControl/css/styledLayerControl.css" />
  <script src="plugins/Leaflet.StyledLayerControl/src/styledLayerControl.js"></script>

  <!-- Add font awesome // CDN -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
    crossorigin="anonymous">

  <!-- Add easybutton plugin // CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

  <!-- Add PM geometry plugin // sources-->
  <link rel="stylesheet" href="plugins/Leaflet.PM/leaflet.pm.css" />
  <!--<script src="plugins/Leaflet.PM/leaflet.pm.min.js"></script>-->
  <script src="plugins/Leaflet.PM/leaflet.pm.hacked.js"></script>

  <!-- MODAL -->

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

  <!-- ADD FUSE.JS // CDN -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.0.4/fuse.min.js"></script>

  <script>
    var lat = 0;
    var lng = 0;
    var map;
    var baseLayer;
    var overlayData = []; //
    var fuse; // Instance of fuse search engine

    

    function init() {

      // Init Leaflet canavs
      var mapMinZoom = 0;
      var mapMaxZoom = 4;
      map = L.map('map', {                       //was a local var but breaks the modal and getitem... should investiguate
        zoomControl: false,
        maxZoom: mapMaxZoom,
        minZoom: mapMinZoom,
        crs: L.CRS.Simple
      }).setView([-38, 60], mapMaxZoom);


      L.control.zoom({
        position: 'bottomright'
      }).addTo(map);

      var mapBounds = new L.LatLngBounds(
        map.unproject([0, 3072], mapMaxZoom),
        map.unproject([2048, 0], mapMaxZoom));

      baseLayer = L.tileLayer('http://localhost:7999/api/tiles/{z}/{x}/{y}', {
        minZoom: mapMinZoom, maxZoom: mapMaxZoom,
        bounds: mapBounds,
        attribution: 'Rendered with <a href="https://www.maptiler.com/">MapTiler</a>',
        noWrap: true,
        tms: false
      }).addTo(map);




      // Init Map Content form backend 

      createMenu(map);

      // Init Search Engine 

      // temporary mockup data

    overlayData = [{
      "_id": "59d0bdf64b86e02c03e97972",
      "type": "Feature",
      "properties": {
        "featureTypeId": 15,
        "displayName": "First judge Archot",
        "description": "He's old and somewhat insane.",
        "owner": "dyingcircle",
        "timestamp": "2017-10-01T10:05:42.535Z"
      },
      "geometry": {
        "coordinates": [63, -44],
        "type": "Point"
      }
    },

    {
      "_id": "59d0bdf64b86e02c03e97973",
      "type": "Feature",
      "properties": {
        "featureTypeId": 16,
        "displayName": "Scrapper Lupo",
        "description": "A scrapper living and working in syracus.",
        "owner": "shamae",
        "timestamp": "2017-10-01T10:05:42.535Z"
      },
      "geometry": {
        "coordinates": [79, -81],
        "type": "Point"
      }
    },
  
    {
      "_id": "59d0bdf64b86e02c03e97973",
      "type": "Feature",
      "properties": {
        "featureTypeId": 16,
        "displayName": "HAdock Capt.",
        "description": "Drinking",
        "owner": "shamae",
        "timestamp": "2017-10-01T10:05:42.535Z"
      },
      "geometry": {
        "coordinates": [160, -51],
        "type": "Point"
      }
    },

    {
      "_id": "59d0bdf64b86e02c03e97973",
      "type": "Feature",
      "properties": {
        "featureTypeId": 16,
        "displayName": "A mysterious stranger",
        "description": "lived a house",
        "owner": "shamae",
        "timestamp": "2017-10-01T10:05:42.535Z"
      },
      "geometry": {
        "coordinates": [79, -81],
        "type": "Point"
      }
    },

    {
      "_id": "59d0bdf64b86e02c03e97973",
      "type": "Feature",
      "properties": {
        "featureTypeId": 16,
        "displayName": "Anabaptist Tintin",
        "description": "doing something",
        "owner": "shamae",
        "timestamp": "2017-10-01T10:05:42.535Z"
      },
      "geometry": {
        "coordinates": [19, -81],
        "type": "Point"
      }
    },
  
  ];
    //end temp mock data
   //TODO: actual binding
    var options = {
        shouldSort: true,
        threshold: 0.6,
        location: 0,
        distance: 100,
        maxPatternLength: 32,
        minMatchCharLength: 2,
        keys: [
          "properties.displayName",
          "properties.description"
      ]
      };
      
      fuse = new Fuse(overlayData, options); // "list" is the item array






      // test easybutton

      /*
            var stateChangingButton = L.easyButton({
              states: [{
                stateName: 'unlogged',        // name the state
                icon: 'fa-sign-in',               // and define its properties
                title: 'Log in',      // like its title
                onClick: function (btn, map) {       // and its callback
                  adminMode = true;
                  alert("Admin mode : " + adminMode);
                  //TODO: login form
                  btn.state('logged');    // change state on click!
                  document.getElementById('loginForm').style.display = 'block'; //summon the login modal
                  refreshUI(map);
                }
              }, {
                stateName: 'logged',
                icon: 'fa-sign-out',
                title: 'Log out',
                onClick: function (btn, map) {
                  adminMode = false;
                  alert("Admin mode : " + adminMode);
      
                  btn.state('unlogged');
                  refreshUI(map);
                }
              }]
            });
      
            stateChangingButton.addTo(map);
      
      */

      // define toolbar options


      map.on('contextmenu', function (e) {

        lat = e.latlng.lat;
        lng = e.latlng.lng;

        document.getElementById('itemForm').style.display = 'block';

      });

      map.on("dragstart", function(e){

        clearSearchList();
      });
      map.on('click', function (e) {
        //var myElement = document.getElementById("log");
        //myElement.innerText = "Lon (X), Lat (Y) : " + e.latlng.lng + ", " + e.latlng.lat;
        //alert("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng)
        
        console.log('[DEBUG] Check the coord?');
        console.log("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng);
        console.log('X, Y =  ' + e.clientX + ", "+e.clientY);
        //fetchAPIdata();


      });

      //end the fiddling
    }

    //extract data from form

    function getItem() {



      console.log('WE ADDED A MARKER' + document.getElementById('itDescr').value);


      addItem(map);
      //closes the modal
      document.getElementById('itemForm').style.display = 'none';

    }


  </script>

</head>

<body onload="init()">
  <div id="map"></div>

    <!-- Searchbox -->

    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
      <symbol xmlns="http://www.w3.org/2000/svg" id="sbx-icon-search-22" viewBox="0 0 40 40">
        <path d="M24.382 25.485c-1.704 1.413-3.898 2.263-6.292 2.263-5.42 0-9.814-4.36-9.814-9.736 0-5.377 4.394-9.736 9.814-9.736s9.815 4.36 9.815 9.736c0 2.126-.687 4.093-1.853 5.694l5.672 5.627-1.73 1.718-5.612-5.565zM20 40c11.046 0 20-8.954 20-20S31.046 0 20 0 0 8.954 0 20s8.954 20 20 20zm-1.91-14.686c4.065 0 7.36-3.27 7.36-7.302 0-4.033-3.295-7.302-7.36-7.302s-7.36 3.27-7.36 7.302c0 4.033 3.295 7.302 7.36 7.302z"
          fill-rule="evenodd" />
      </symbol>
      <symbol xmlns="http://www.w3.org/2000/svg" id="sbx-icon-clear-4" viewBox="0 0 20 20">
        <path d="M11.664 9.877l4.485 4.485-1.542 1.54-4.485-4.485-4.485 4.485-1.54-1.54 4.485-4.485-4.485-4.485 1.54-1.54 4.485 4.484 4.485-4.485 1.54 1.542-4.484 4.485zM10 20c5.523 0 10-4.477 10-10S15.523 0 10 0 0 4.477 0 10s4.477 10 10 10z"
          fill-rule="evenodd" />
      </symbol>
    </svg>
    <div class="top-left-pane">
      <form novalidate="novalidate" onsubmit="return false;" class="searchbox sbx-custom">
        <div role="search" class="sbx-google__wrapper">
          <input id="srchInputField" name="search" placeholder="Search your website" autocomplete="off" required="required" class="sbx-custom__input"
            type="search" onkeyup="searchItem()"
            onchange="searchItem()">
          <button type="submit" title="Submit your search query." class="sbx-custom__submit">
            <svg role="img" aria-label="Search">
              <use xlink:href="#sbx-icon-search-22"></use>
            </svg>
          </button>
          <button type="reset" title="Clear the search query." class="sbx-custom__reset">
            <svg role="img" aria-label="Reset">
              <use xlink:href="#sbx-icon-clear-4"></use>
            </svg>
          </button>
        </div>
      </form>
    
      <div id="srchResults"></div>
    </div>
  <div class="top-right-pane">
    <div id="signInBtn">
      <i class="fa fa-sign-in" aria-hidden="true"></i>
      Sign in </div>
  </div>


  <div class="w3-container">

    <div id="itemForm" class="w3-modal">
      <div class="w3-modal-content w3-card-4 w3-animate-zoom" style="max-width:600px">

        <div class="w3-center">
          <br>
          <span onclick="document.getElementById('itemForm').style.display='none'" class="w3-button w3-xlarge w3-hover-red w3-display-topright"
            title="Close Modal">&times;</span>
        </div>

        <form class="w3-container">
          <div class="w3-section">
            <select id="itType">

              <option value="15">Non-Player Character</option>
              <option value="16">Player Character</option>

            </select>
            <label>
              <b>Name</b>
            </label>
            <input class="w3-input w3-border w3-margin-bottom" type="text" placeholder="Display name..." name="displayname" id="itName"
              required>
            <label>
              <b>Description</b>
            </label>
            <input class="w3-input w3-border" type="text" placeholder="Enter Password" name="Description" id="itDescr" required>
            <button class="w3-button w3-block w3-green w3-section w3-padding" type="button" onclick="getItem()">ADD</button>
          </div>
        </form>

        <div class="w3-container w3-border-top w3-padding-16 w3-light-grey">
          <button onclick="document.getElementById('itemForm').style.display='none'" type="button" class="w3-button w3-red">Cancel</button>
        </div>

      </div>
    </div>
  </div>



  <div class="w3-container">

    <div id="loginForm" class="w3-modal">
      <div class="w3-modal-content w3-card-4 w3-animate-zoom" style="max-width:600px">

        <div class="w3-center">
          <br>
          <span onclick="document.getElementById('loginForm').style.display='none'" class="w3-button w3-xlarge w3-hover-red w3-display-topright"
            title="Close Modal">&times;</span>
          <img src="img_avatar4.png" alt="Avatar" style="width:30%" class="w3-circle w3-margin-top">
        </div>

        <form class="w3-container" action="#">
          <div class="w3-section">

            <label>
              <b>Username</b>
            </label>
            <input class="w3-input w3-border w3-margin-bottom" type="text" placeholder="Enter Username" name="usrname" required>
            <label>
              <b>Password</b>
            </label>
            <input class="w3-input w3-border" type="password" placeholder="Enter Password" name="psw" required>
            <button class="w3-button w3-block w3-green w3-section w3-padding" type="submit">Login</button>
            <input class="w3-check w3-margin-top" type="checkbox" checked="checked"> Remember me
          </div>
        </form>

        <div class="w3-container w3-border-top w3-padding-16 w3-light-grey">
          <button onclick="document.getElementById('loginForm').style.display='none'" type="button" class="w3-button w3-red">Cancel</button>
          <span class="w3-right w3-padding w3-hide-small">Forgot
            <a href="#">password?</a>
          </span>
        </div>

      </div>
    </div>
  </div>


  <script type="text/javascript">
    document.querySelector('.searchbox [type="reset"]').addEventListener('click', function () { this.parentNode.querySelector('input').focus(); });
  </script>

</body>

</html>